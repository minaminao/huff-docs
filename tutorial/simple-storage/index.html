<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Simple Storage | Huff Language</title>
    <meta name="generator" content="VuePress 1.9.7">
    
    <meta name="description" content="Documentation for the Huff Language">
    <meta name="theme-color" content="#c70202">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    
    <link rel="preload" href="/huff-docs/assets/css/0.styles.119aef57.css" as="style"><link rel="preload" href="/huff-docs/assets/js/app.52368d7d.js" as="script"><link rel="preload" href="/huff-docs/assets/js/2.da23fb4f.js" as="script"><link rel="preload" href="/huff-docs/assets/js/24.eaa45c75.js" as="script"><link rel="prefetch" href="/huff-docs/assets/js/10.10b20d65.js"><link rel="prefetch" href="/huff-docs/assets/js/11.0a86e14c.js"><link rel="prefetch" href="/huff-docs/assets/js/12.dc56caf4.js"><link rel="prefetch" href="/huff-docs/assets/js/13.d80e3d66.js"><link rel="prefetch" href="/huff-docs/assets/js/14.f739287c.js"><link rel="prefetch" href="/huff-docs/assets/js/15.1d27754b.js"><link rel="prefetch" href="/huff-docs/assets/js/16.b8ce2f87.js"><link rel="prefetch" href="/huff-docs/assets/js/17.fc855309.js"><link rel="prefetch" href="/huff-docs/assets/js/18.cb791716.js"><link rel="prefetch" href="/huff-docs/assets/js/19.e1225b3f.js"><link rel="prefetch" href="/huff-docs/assets/js/20.a0343151.js"><link rel="prefetch" href="/huff-docs/assets/js/21.cea4001d.js"><link rel="prefetch" href="/huff-docs/assets/js/22.bc6ece12.js"><link rel="prefetch" href="/huff-docs/assets/js/23.7475dd5b.js"><link rel="prefetch" href="/huff-docs/assets/js/25.b5e7e06d.js"><link rel="prefetch" href="/huff-docs/assets/js/3.ccc119cc.js"><link rel="prefetch" href="/huff-docs/assets/js/4.0afa7f3a.js"><link rel="prefetch" href="/huff-docs/assets/js/5.75baa7dd.js"><link rel="prefetch" href="/huff-docs/assets/js/6.5a1f7be2.js"><link rel="prefetch" href="/huff-docs/assets/js/7.bffed0f4.js"><link rel="prefetch" href="/huff-docs/assets/js/8.ef392763.js"><link rel="prefetch" href="/huff-docs/assets/js/9.836eefc0.js">
    <link rel="stylesheet" href="/huff-docs/assets/css/0.styles.119aef57.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/huff-docs/" class="home-link router-link-active"><!----> <span class="site-name">Huff Language</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/huff-docs/" class="nav-link">
  Home
</a></div><div class="nav-item"><a href="/huff-docs/get-started/overview/" class="nav-link">
  Get Started
</a></div><div class="nav-item"><a href="/huff-docs/tutorial/overview/" class="nav-link">
  Tutorials
</a></div><div class="nav-item"><a href="/huff-docs/style-guide/overview/" class="nav-link">
  Style Guide
</a></div><div class="nav-item"><a href="/huff-docs/resources/overview/" class="nav-link">
  Resources
</a></div><div class="nav-item"><a href="/huff-docs/contribute/overview/" class="nav-link">
  Contribute
</a></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/huff-docs/" class="nav-link">
  Home
</a></div><div class="nav-item"><a href="/huff-docs/get-started/overview/" class="nav-link">
  Get Started
</a></div><div class="nav-item"><a href="/huff-docs/tutorial/overview/" class="nav-link">
  Tutorials
</a></div><div class="nav-item"><a href="/huff-docs/style-guide/overview/" class="nav-link">
  Style Guide
</a></div><div class="nav-item"><a href="/huff-docs/resources/overview/" class="nav-link">
  Resources
</a></div><div class="nav-item"><a href="/huff-docs/contribute/overview/" class="nav-link">
  Contribute
</a></div> <!----></nav>  <ul class="sidebar-links"><li><section class="sidebar-group depth-0"><p class="sidebar-heading open"><span>Tutorials</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/huff-docs/tutorial/overview/" class="sidebar-link">Overview</a></li><li><a href="/huff-docs/tutorial/evm-basics/" class="sidebar-link">Understanding the EVM</a></li><li><a href="/huff-docs/tutorial/the-basics/" class="sidebar-link">The Basics</a></li><li><a href="/huff-docs/tutorial/hello-world/" class="sidebar-link">Hello, world!</a></li><li><a href="/huff-docs/tutorial/simple-storage/" aria-current="page" class="active sidebar-link">Simple Storage</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/huff-docs/tutorial/simple-storage/#storage-in-huff" class="sidebar-link">Storage in Huff</a></li><li class="sidebar-sub-header"><a href="/huff-docs/tutorial/simple-storage/#setting-storage" class="sidebar-link">Setting storage</a></li><li class="sidebar-sub-header"><a href="/huff-docs/tutorial/simple-storage/#reading-from-storage" class="sidebar-link">Reading from storage</a></li><li class="sidebar-sub-header"><a href="/huff-docs/tutorial/simple-storage/#simple-storage-implementation" class="sidebar-link">Simple Storage Implementation</a></li></ul></li><li><a href="/huff-docs/tutorial/function-dispatching/" class="sidebar-link">Function Dispatching</a></li><li><a href="/huff-docs/tutorial/huff-testing/" class="sidebar-link">Testing Huff with Foundry</a></li></ul></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="simple-storage"><a href="#simple-storage" class="header-anchor">#</a> Simple Storage</h1> <p>これまでの 2 つの例では、calldata からバイトを切り出し、メモリに格納し、値を返すということを検討してきました。次に、すべてのEVM開発者が恐れているパズルの欠けた部分、ストレージに取り組みます。</p> <h2 id="storage-in-huff"><a href="#storage-in-huff" class="header-anchor">#</a> Storage in Huff</h2> <p>Huffは<code>FREE_STORAGE_POINTER()</code>キーワードを使ってストレージ変数の追跡を抽象化しているので、ストレージを扱うのはそれほど複雑ではありません。以下にその例を示します。</p> <div class="language- extra-class"><pre class="language-text"><code>#define constant STORAGE_SLOT0 = FREE_STORAGE_POINTER()
#define constant STORAGE_SLOT1 = FREE_STORAGE_POINTER()
#define constant STORAGE_SLOT2 = FREE_STORAGE_POINTER()
</code></pre></div><p>ストレージスロットは、コントラクトがその状態を保持する非常に大きな配列の単なるキーです。コンパイラはコンパイル時に<code>STORAGE_SLOT0</code>に<code>0</code>、<code>STORAGE_SLOT1</code>に<code>1</code>などの値を代入します。コード全体では、どの言語でも定数が使われるのと同じように、ストレージスロットを参照するだけです。</p> <h2 id="setting-storage"><a href="#setting-storage" class="header-anchor">#</a> Setting storage</h2> <p>まず、<code>FREE_STORAGE_POINTER()</code>キーワードを使用して、ストレージスロットを表す定数を定義します。</p> <div class="language- extra-class"><pre class="language-text"><code>#define constant VALUE = FREE_STORAGE_POINTER()
</code></pre></div><p><code>[VALUE]</code>のように角括弧で囲むことで、コード全体でこのスロットを参照することができます。以下の例では、スロット [VALUE] に値 5 を格納するマクロを例示しています。</p> <div class="language- extra-class"><pre class="language-text"><code>#define macro SET_5() = takes(0) returns(0) {
    0x5             // [0x5] 
    [VALUE]         // [value_slot_pointer, 0x5]
    sstore          // []
}
</code></pre></div><p>インタラクティブにテストする <a href="https://www.evm.codes/playground?unit=Wei&amp;codeType=Bytecode&amp;code='6005600055'_" target="_blank" rel="noopener noreferrer">here<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> ([VALUE]は0にハードコードされています)</p> <h2 id="reading-from-storage"><a href="#reading-from-storage" class="header-anchor">#</a> Reading from storage</h2> <p>これで、ストレージへの書き込み方法がわかったので、ストレージからの読み出しは簡単です。<code>sstore</code> を <code>sload</code> に置き換えるだけで、準備は完了です。これから、上の例を拡張して、ストレージへの書き込みと読み込みの両方を行うことにします。</p> <div class="language- extra-class"><pre class="language-text"><code>#define macro SET_5_READ_5() = takes(0) returns(0) {
    0x5
    [VALUE]
    sstore

    [VALUE]
    sload
}
</code></pre></div><p>いいねーもう一度、<a href="https://www.evm.codes/playground?unit=Wei&amp;codeType=Bytecode&amp;code='6005600055600054'_" target="_blank" rel="noopener noreferrer">evm.codes<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> でテストしてみましょう。<code>sload</code> 命令を実行した後、スタック上に 5 が再び現れることに注目してください。</p> <h2 id="simple-storage-implementation"><a href="#simple-storage-implementation" class="header-anchor">#</a> Simple Storage Implementation</h2> <p>これでストレージへの読み書きができるようになったので、remix の有名な SimpleStorage スターターコントラクトを試してみましょう。</p> <p>まず、インターフェイスを作成しましょう。</p> <div class="language- extra-class"><pre class="language-text"><code>#define function setValue(uint256) nonpayable returns ()
#define function getValue() nonpayable returns (uint256)
</code></pre></div><p>次に、ストレージスロットを定義します。</p> <div class="language- extra-class"><pre class="language-text"><code>#define constant VALUE = FREE_STORAGE_POINTER()
</code></pre></div><p>さて、いよいよロジックです。addTwoの例で、<code>calldataload</code>オペコードを使って32バイトのチャンクでデータを読むことができたことを思い出してください。</p> <div class="language- extra-class"><pre class="language-text"><code>#define macro SET_VALUE() = takes(0) returns(0) {
    // Read uint256 from calldata, remember to read from byte 4 to allow for the function selector! 
    0x04            // [0x04]
    calldataload    // [value]

    // Get pointer and store
    [VALUE]         // [value_ptr, value]
    sstore          // []
}
</code></pre></div><p>これまでの例題を終えて、Huff の書き方がわかってきたと思います。このパターンは、独自のコントラクトを書くときに、calldata から値を読み、メモリやストレージに値を格納するときに非常によく使われます。</p> <p>次は、格納されている値の読み出しです。</p> <div class="language- extra-class"><pre class="language-text"><code>#define macro GET_VALUE() = takes(0) returns(0) {
    // Read uint256 from storage
    [VALUE]         // [value_ptr]
    sload           // [value]

    // Store the return value in memory
    0x00            // [0x00, value]
    mstore          // []

    // Return the first 32 bytes of memory containing our uint256
    0x20            // [0x20]
    0x00            // [0x00, 0x20]
    return          // []
}
</code></pre></div><p>まず、先ほどの例と同様の手法で記憶値を読み取ります。戻り値をメモリに格納して準備します。そして、その値をメモリから返します。まとまってきましたね〜。</p> <p>外部関数から新しいマクロを呼び出すには、ディスパッチャを作成する必要があります。</p> <div class="language- extra-class"><pre class="language-text"><code>#define macro MAIN() = takes(0) returns(0) {
    
    // Get the function selector
    0x00 calldataload 0xe0 shr

    dup1 0x55241077 eq setValue jumpi // Compare function selector to setValue(uint256)
    dup1 0x20965255 eq getValue jumpi // Compare the function selector to getValue()

    // dispatch
    setValue:
        SET_VALUE()
    getValue:
        GET_VALUE()

    0x00 0x00 revert
}
</code></pre></div><p>今度は全部一緒に!</p> <div class="language- extra-class"><pre class="language-text"><code>// Interface
#define function setValue(uint256) nonpayable returns ()
#define function getValue() nonpayable returns (uint256)

// Storage
#define constant VALUE = FREE_STORAGE_POINTER()

// External function macros

// setValue(uint256)
#define macro SET_VALUE() = takes(0) returns(0) {
    // Read uint256 from calldata, remember to read from byte 4 to allow for the function selector! 
    0x04            // [0x04]
    calldataload    // [value]

    // Get pointer and store
    [VALUE]         // [value_ptr, value]
    sstore          // []
}

// getValue()
#define macro GET_VALUE() = takes(0) returns(0) {
    // Read uint256 from storage
    [VALUE]         // [value_ptr]
    sload           // [value]

    // Store the return value in memory
    0x00            // [0x00, value]
    mstore          // []

    // Return the first 32 bytes of memory containing our uint256
    0x20            // [0x20]
    0x00            // [0x00, 0x20]
    return          // []
}

// Main
#define macro MAIN() = takes(0) returns(0) {
    // Get the function selector
    0x00 calldataload 0xe0 shr

    dup1 __FUNC_SIG(setValue) eq setValue jumpi // Compare function selector to setValue(uint256)
    dup1 __FUNC_SIG(getValue) eq getValue jumpi // Compare the function selector to getValue()

    // dispatch
    setValue:
        SET_VALUE()
    getValue:
        GET_VALUE()

    0x00 0x00 revert
}
</code></pre></div><p>おめでとうございます。あなたは、Huffでコントラクトを書くための殻を乗り越えたのです。次のステップとしては、addTwo, &quot;Hello, World!&quot;, SimpleStorageでこれまでに学んだことを、<a href="https://docs.huff.sh/tutorial/huff-testing/" target="_blank" rel="noopener noreferrer">Foundry<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>のようなテストフレームワークに取り入れることをお勧めします。それでは、ハッキングを楽しんでください。</p></div> <footer class="page-edit"><!----> <!----></footer> <div class="page-nav"><p class="inner"><span class="prev">
      ←
      <a href="/huff-docs/tutorial/hello-world/" class="prev">
        Hello, world!
      </a></span> <span class="next"><a href="/huff-docs/tutorial/function-dispatching/">
        Function Dispatching
      </a>
      →
    </span></p></div> </main></div><div class="global-ui"></div></div>
    <script src="/huff-docs/assets/js/app.52368d7d.js" defer></script><script src="/huff-docs/assets/js/2.da23fb4f.js" defer></script><script src="/huff-docs/assets/js/24.eaa45c75.js" defer></script>
  </body>
</html>
